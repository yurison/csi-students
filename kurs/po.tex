\section{Разработка програмного обеспечения}
\subsection{Формирование алгоритма управления}
Сетевая архитектура представлена на Рисунке 4.
\begin{figure}[h]
	\centering		 
	\includegraphics[width=5.5in]{./img/img42.jpg}	
	\caption{Сетевая архитектура}
	\label{fig_img511}
\end{figure}

У робота есть всего две группы параметров позиционирования: 
\begin{enumerate}
	
	\item{ углы поворотов шести джоинтов }
	\item{ Положение фланца, заданное в x,y,z координатах, и его ориентация, заданная в o,a,t углах  Эйлера в $zyz$ конвенции.}
\end{enumerate}

Т.к. робот получает управляющие команды по протоколу tcp ip, и контроль безошибочности передачи заложен в самом протоколе \cite{tcpip}, то нам остаётся разработать собственный формат посылки.
\subsection{Структура посылки}
Т.к. при позиционировании робот использует 6 величин, то необходимо реализовать посылку следующим образом.

В силу функциональных особенностей внутреннего языка программирования контроллеров RoboticAS\cite{ASlang}, самым оптимальным способом передачи данных по протоколу TCP IP является отправка символьных строк, содержащих в себе данные, разделённых пробелом (разделительным символом).  Единственное требование к такому представлению: каждое число должно быть представлено шестью символами. В случае, если число меньше $10^5$, то недостающие разряды должны быть заполнены цифрой 0. Например, число 123 должно быть представлено в выходной строке, как 000123.
Минимальная единица посылки, называемая кадром, является целым числом. 

Т.к. при использовании протокола tcp ip все символы строки гарантированно будут доставлены от передатчика к приёмнику, то механизм обработки принятых сообщений можно построить следующим образом: все входящие символы добавляются в буфер с конца, как только длина буфера превышает число $n=k*w$, где $k$ - кол-во кадров в посылке,$w$ - размер кадра в символах, то из буфера берутся первые $n$ символов и переводятся в $k$ целых чисел.

Т.к. параметров позиционирования у робота-манипулятора шесть, то в размер посылки требуется заложить в девять кадров.

\begin{figure}[ht]
	\centering		 
	\includegraphics{./img/img41.jpg}	
	\caption{
		\textbf{ Структура посылки:} 				
		ID- уникальный  номер управляющей команды(id);	 				
		Com - номер управляющей команды;	 				
		Param- параметр управляющей команды(запасной);	 				
		Vec1...Vec6 - вектор параметров управляющей команды}     
	\label{fig_img51}
\end{figure}

\subsection{Управление Кавасаки}
Всего есть три основных группы управления:
\begin{enumerate} 
	\item{По положению. Вектор параметров имеет следующую структуру: 
		
		1) Vec1 – X координата фланца;
		
		2) Vec2 – Y координата фланца;
		
		3) Vec3 – Z координата фланца;
		
		4) Vec4 – O угол Эйлера;
		
		5) Vec5 – A угол Эйлера; 
		
		6) Vec6 – T угол Эйлера;
	}
	\item{По абсолютным углам поворота джоинтов. i-ая координата отвечает угол поворота  i-го джоинта.}
	\item{По относительным углам поворота джоинтов.  i-ая координата отвечает  за относительный поворот  i-го джоинта.}
\end{enumerate}

Внутренняя программа контролера построена следующим образом: запущено 3 параллельных процесса: первый в бесконечном цикле отправляет данные о положении фланца, его ориентации и углах поворота шести джоинтов. Второй процесс в бесконечном цикле проверяет, не пришло ли новых символов и по каналу связи и добавляет их к буферу. Третий  процесс в бесконечном цикле обрабатывает входящие управляющие команды и запускает вспомогательные программы внутреннего управления, если такое управление было запущено.

\subsection{Внешние управляющие программы.}
\begin{enumerate}  
	\item{	Вывод робота в заданную точку по координатам (X,Y,Z,O,A,T). В вектор параметров передаются соответствующие координаты. }
	\item{	Вывод робота в заданную конфигурацию поворотов джоинтов. В вектор параметров передаются соответствующие углы поворота джоинтов.}
	\item{	Поворот джоинтов робота на заданные углы В вектор параметров передаются соответствующие углы поворотов джоинтов.
		При получении любой из первых трёх команд робот сразу же запускает внутреннюю команду перемещения. Поле Param остаётся нулевым.}
	\item{	Передача значений показаний силомоментного датчика в базовой системе координат (преобразование реальных показаний датчиков производится на стороне PC). Поле Param остаётся нулевым.}
	\item{	Задание скоростей и ускорений. Поле Param остаётся нулевым, значения Vec1-Vec4 следующие: ускорение в процентах, замедление в процентах, модульная скорость в процентах, механическая скорость в мм/с. Реальная скорость робота является произведением механической на модульную скорости.}
	\item{	Задание коэффициентов регулирования. При поле Param, равном нулю задаются пропорциональные коэффициенты $kx,ky,kz,kmx,kmy,kmz$, при поле Param, равном 1 задаются интегральные коэффициенты  $ix,iy,iz,imx,imy,Imz$.}
	\item{	Запуск программы force feedback. При Param, равном 0 – запускает "Force feedback position" режим стабилизации показаний $x,y,z$ компонент силомоментного датчика в нулевых значениях  за счёт смещений по $x,y,z$ осям. При Param равном 1 – запускается "Force feedback orientation" режим стабилизации $mx,my,mz$ показаний силомоментного датчика в нулевых значениях. При Param равном 2 останавливается выполнение force feedback.}
\end{enumerate}   

\subsection{Работа Force Feedback}

Из-за низкой производительности контроллера Kawasaki все математические вычисления производятся на ПК. Контроллер получает уже преобразованные значения $x,y,z$ компонент силы в базисе базовой системы координат. $M_x$, $M_y$ и $M_z$ – моменты, возникающие вдоль осей $x,y$ и $z$ базовой системы координат. Режим "Force feedback position" реализуется при помощи ПИ регулятора, где за ошибку берётся значения $x,y,z$ компонент силомоментного датчика. Выходом регулятора  является  новое положение робота на следующей итерации главного цикла программы.  

Режим "Force feedback orientation" реализуется более сложным способом. Также строится ПИ регулятор, за ошибку берутся показания моментов $Mx, My, Mz$, Выходом регулятора являются углы поворотов с третьего по шестой джоинтов.

Итого, можно сформировать три задачи:
\begin{enumerate}   
	\item{	Преобразование значения силы  из системы координат датчика в базовую систему координат и компенсация силы тяжести инструмента. }
	\item{	Преобразование значений моментов из системы координат датчика в базовую систему координат и компенсация момента силы тяжести инструмента.}
	\item{	Непосредственная реализация режимов force feedback.}
\end{enumerate}   